# Face recognition example

In this example, you learn how to implement inference code with a pytorch model to extract and compare face features.

Extract face feature:
The source code can be found at [FeatureExtraction.java](https://github.com/awslabs/djl/blob/master/examples/src/main/java/ai/djl/examples/inference/face/FeatureExtraction.java).  
The model github can be found at [facenet-pytorch](https://github.com/timesler/facenet-pytorch).

Compare face features:
The source code can be found at [FeatureComparision.java](https://github.com/awslabs/djl/blob/master/examples/src/main/java/ai/djl/examples/inference/face/FeatureComparision.java).  

## Setup guide

To configure your development environment, follow [setup](../../docs/development/setup.md).

## Run face recognition example

### Input image file
You can find the image used in this example in the project test resource folder:  
 `src/test/resources/kana1.jpg`  
![kana1](../src/test/resources/kana1.jpg)     
 `src/test/resources/kana2.jpg`  
![kana2](../src/test/resources/kana2.jpg)  

### Build the project and run
Use the following command to run the project:

```
cd examples
./gradlew run -Dmain=ai.djl.examples.inference.face.FeatureExtraction
```

Your output should look like the following:

```text
[INFO ] - [-0.04026184, -0.019486362, -0.09802659, 0.01700999, 0.037829027, 0.030801108, -0.027146917, 0.042024307, -0.009838448, -0.0059610037, -0.07119215, 0.08786042, 0.0072166645, -0.021355117, 0.005737103, 0.01481565, 0.0064187907, 0.016628504, 0.015872061, -0.08208024, -0.036399554, 0.022988075, 0.049233627, -0.017719803, 0.05970869, 0.0029967816, -0.001822553, -0.061923336, -0.0058413167, 0.041546635, 0.025759378, -0.027837029, 0.010697747, -0.0012607182, -0.052020296, 0.036131322, 0.05275434, -0.017132897, -0.08581672, 0.100559995, 0.004115776, -0.013585379, -0.014154135, 0.06089751, 0.0305514, 0.003209107, 0.033525735, 0.043628372, -0.09334458, -0.04518878, 0.009731176, 0.0022225506, 0.021579968, -0.032024927, -0.06377051, 0.04609301, -0.010585218, 0.040007453, -0.005020635, -0.109918624, 0.0084302, 0.040465124, -0.08817649, -0.08987097, -0.057349715, 0.081648804, -0.0062028086, 0.009363555, -0.026541812, -0.0038018092, 0.044862423, -0.02313707, -0.010479241, -0.006226896, 0.033265155, -0.017805677, -0.018945817, 0.017691052, -0.013475699, 0.022529509, 0.016858289, 0.016943956, 0.03288718, -0.036700383, -0.057765167, 0.035178963, -0.07668997, 0.084453784, -0.062370047, -0.020355387, 0.026339773, -0.017617134, 0.04173394, -0.048418634, 0.042927686, -0.032747943, 0.016062887, 0.0048702024, -0.033044733, 0.079281, 0.0010960235, 1.3900083E-4, 0.058286477, -0.04340951, 0.0013900948, 0.03960979, -0.010684902, -0.08131514, -0.027819464, -0.043281816, 0.032143004, 0.006680073, -0.043717567, -0.018342812, 0.077648886, 0.010551311, 0.059085794, -0.005229899, -0.028077547, 0.007278699, -0.023197437, 0.014703774, 0.009587386, 0.055157535, -0.015618582, -0.06432965, -0.028449586, 0.032133922, 0.05281294, -0.06644661, 0.057903785, -0.023972662, 0.06166538, -0.03192106, -0.035501678, -0.01502715, 0.03884574, -0.04704856, 0.060351722, -0.0133809885, -0.06708287, -0.00954641, -0.04621629, 0.05277549, 0.11187778, -0.036545895, 0.0043303864, -0.044915915, 0.059867773, -0.028147668, -0.048172854, -0.04173142, -0.017604722, 0.0163541, 0.07184021, -0.06366158, 0.080329925, 0.0056497743, 0.040228475, 0.011983586, 0.041354224, 0.023615072, -0.0057740207, 0.01886461, 0.055974927, 0.087919354, -0.07664695, -0.014522028, -0.015740741, -0.008927155, -0.06091684, -0.006990669, 0.007827623, 0.073011495, -0.015005867, -0.020437595, 0.059680484, -0.031139407, -0.061410002, 0.028822644, 0.02437206, -0.050070465, -0.013305051, 0.07890263, 0.05707964, 0.02637617, 0.01126833, 0.03817408, 0.09550674, 0.040790882, -0.023366377, -0.03800785, 0.032664925, 0.04378137, 0.0025677222, 0.016267948, 0.099256344, 0.047597047, -0.0018664652, 0.06123046, -0.0103597585, -0.10732233, 0.013145942, -0.045635197, -0.0054395623, 0.0020043708, 0.070844196, 0.03673302, 0.037198447, 0.017733354, -0.046561617, 0.037813243, 0.002226788, 0.05714862, 0.007333937, 0.03972541, -0.05871666, -0.045202628, -0.034661744, -0.05909011, -0.10324218, -0.062593654, 0.009877816, -0.02559644, -0.02766223, -0.01464534, -0.046762213, -0.0750673, 0.03629894, 0.011175676, -0.07898087, 0.05366169, 0.0436684, -0.003930501, -0.016525535, 0.009769832, 0.040277474, -0.031827614, 0.009453062, -0.046724577, -0.017037587, 0.0035288578, 0.022885382, -0.010471433, -0.0056472113, 0.030873396, 0.030147621, 0.025294859, -0.05018424, 0.021795193, 0.06879111, 0.06327159, 0.0063878684, -0.06343861, 0.044653267, -0.018809505, 0.074988276, -0.008528463, 0.03476152, 0.012752744, 0.025200052, 0.02841543, -0.08731174, 0.038915563, -0.030964809, 0.043812003, 0.029315654, -0.04265204, -0.07061982, 0.0017888116, -0.104689725, -0.0044106236, -0.08144414, -0.07739566, -0.03480038, -0.037939537, 0.072800726, 0.017380929, 0.071517795, 0.003077013, 0.10690897, -0.026069442, -0.0044642757, -8.47709E-4, 0.050485484, -0.011470874, -0.02149468, -0.035392094, 0.03984104, 0.004919987, 0.018029666, -0.019392652, 0.03736214, 0.012554693, -0.05248692, 0.036819026, -0.016256368, 0.05544121, 0.06921561, 0.104484625, 0.0063812304, 0.025498971, 0.0026547092, 0.008120558, -1.6568718E-4, -0.041439533, 0.021948272, -0.051953267, -0.053767484, -0.006186402, -0.013835365, 0.050020747, 0.039076205, -0.018549126, -0.0284095, 0.048878256, -0.015647696, 0.0136728855, -0.0012782156, 0.0457528, 0.08373879, -0.026593124, -0.042995155, 0.05227124, -0.060754847, 0.02744823, 0.032256767, -0.025928803, 0.015614243, 0.079304, 0.00935207, 0.027410232, -0.008599193, 0.019779472, -0.078676745, -0.020067526, -0.02492289, 0.008303484, 0.09733468, -0.006621209, -0.023494888, -0.014917946, 0.0068328064, 0.07722445, -0.04657758, -0.0077574314, 0.0027327323, -0.014362855, 0.023754459, -0.012208515, -9.332832E-4, 0.061519846, 0.007907478, -0.085384846, 0.043833062, 0.009285412, 0.006220665, -0.007241633, -0.016792065, -0.045293245, 0.013571477, -0.037002224, -0.05068167, -0.015303927, 0.058861252, 0.028253237, 0.048441693, 0.024922002, 0.005810931, -0.023098871, -0.008186173, -0.08034856, 0.035920452, -0.02706945, 0.021887412, -0.013821149, -0.049288396, 0.007104188, 0.0034900287, -0.063382514, -0.023870002, -0.048068438, 0.0144884065, 0.00932647, -0.07802181, -0.0016468724, -0.022284523, -0.107638665, 0.031679496, -0.021825302, -0.009800595, -0.010960805, 0.049558565, 0.011680269, -0.022881791, 0.03022306, 0.065352805, 0.05567314, 0.010206145, 0.014593878, -0.026901957, 0.056856766, -0.017259074, 0.00900995, -0.010772391, 0.017463151, -0.009896868, -0.025104905, -0.008175915, 0.005664781, -0.013260411, -0.0735458, 0.01165336, -0.03149427, 0.012603661, 0.10546523, 0.07216644, -0.02514606, 0.024485772, -0.058440935, -0.024542606, 0.043339614, 0.022481307, 0.037639476, -0.08548609, -0.01144411, -0.009090469, 0.028074916, 0.028374849, -0.0067159394, -0.039607055, 0.04859214, -0.03865035, 2.9159928E-4, -0.038900234, -0.033497393, 0.041361727, 0.047099542, -0.02974487, 0.031694166, 0.02194149, -0.0046732468, -0.034601685, 0.07589564, 0.02340233, 0.01645314, -0.04975197, -0.09678926, 0.0266368, -0.03970332, 0.0022513054, 0.09571624, -0.09096238, -0.036827184, 0.018079175, -0.0028671524, 0.011538415, 0.055565774, 0.051667403, 3.5102156E-4, 0.030812282, 4.235741E-4, -0.0070647, -0.013426111, 0.03030763, -0.015629206, -0.124456614, 0.061266568, 0.058517333, 0.05863142, 0.014240835, 0.083301544, -0.008888505, 0.003932139, -0.03446915, -0.097598195, -7.5692456E-4, -0.055613603, 0.051524952, 0.10868975, -0.06169573, -0.051091563, -0.008621663, 0.015559557, 0.106395945, 0.03277783, -0.0214844, -0.028420953, 0.06978768, -0.038912285, 0.051705502, -0.035968315, -0.028398497, -0.015948035, 0.007675243, -0.02051244, 0.056429986, 0.024327064, 0.044809565, 0.05362815, -0.03933861, -0.0029656875, -3.128731E-5, 0.038520306, -0.08196849, 0.10360013, 0.07101253, 0.0015945982, -0.02769288, -0.01212006, 0.03114792, -0.032064643]
```

```
cd examples
./gradlew run -Dmain=ai.djl.examples.inference.face.FeatureComparision
```

Your output should look like the following:

```text
[INFO ] - 0.9022607
```

## Reference - how to import pytorch model:

1. Install:
    
```bash
# With pip:
pip install facenet-pytorch

# or clone this repo, removing the '-' to allow python imports:
git clone https://github.com/timesler/facenet-pytorch.git facenet_pytorch

```
    
2. In python, import facenet-pytorch and instantiate model, then use torch.jit.trace to generate a torch.jit.ScriptModule via tracing:
    
```python
from facenet_pytorch import InceptionResnetV1
import torch
from PIL import Image
import ssl

try:
    _create_unverified_https_context = ssl._create_unverified_context
except AttributeError:
    # Legacy Python that doesn't verify HTTPS certificates by default
    pass
else:
    # Handle target environment that doesn't support HTTPS verification
    ssl._create_default_https_context = _create_unverified_https_context

# Create an inception resnet (in eval mode):
resnet = InceptionResnetV1(pretrained='vggface2').eval()

img = Image.open('/path/to/any/face/image.jpg')

# An example input you would normally provide to your model's forward() method.
example = torch.rand(1, 3, 320, 320)

# Use torch.jit.trace to generate a torch.jit.ScriptModule via tracing.
traced_script_module = torch.jit.trace(resnet, example)

# For control flow, use script
#script_module = torch.jit.script(model) 

# Save the TorchScript model
traced_script_module.save("face_feature.pt")

output = traced_script_module(torch.rand(1,3,320, 320))
#print(traced_script_module.code)
print(output)

```